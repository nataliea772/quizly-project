name: Deploy to EC2

on:
  push:
    branches:
      - main  # or your main deployment branch

permissions:
  contents: read
  actions: write
  id-token: write

jobs:
  deploy:
    name: Deploy to EC2 Instance
    runs-on: ubuntu-latest
    
    steps:
    - name: Manual Checkout
      run: |
        git clone https://oauth2:${{ secrets.PAT_TOKEN }}@github.com/nataliea772/quizly-project.git .
        git checkout main

    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - name: Install dependencies
      run: npm install

    - name: Build project
      run: npm run build

    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/key
        chmod 600 ~/.ssh/key
        echo -e "Host *\n\tStrictHostKeyChecking no\n\tUserKnownHostsFile=/dev/null\n" > ~/.ssh/config

    - name: Deploy to EC2
      run: |
        rsync -avz -e "ssh -i ~/.ssh/key" out/ server.js package.json package-lock.json nginx.conf ubuntu@${{ secrets.EC2_HOST }}:/home/ubuntu/quizapp/
        ssh -i ~/.ssh/key ubuntu@${{ secrets.EC2_HOST }} '
          cd /home/ubuntu/quizapp &&
          npm install &&
          sudo cp nginx.conf /etc/nginx/sites-available/quizapp &&
          sudo ln -sf /etc/nginx/sites-available/quizapp /etc/nginx/sites-enabled/ &&
          sudo rm -f /etc/nginx/sites-enabled/default &&
          sudo nginx -t && sudo systemctl restart nginx &&
          pm2 restart quizapp || pm2 start server.js --name quizapp &&
          pm2 save
        '
