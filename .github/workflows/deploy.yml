name: Deploy to EC2

on:
  push:
    branches:
      - main  # or your main deployment branch

permissions:
  contents: read
  actions: write
  id-token: write

jobs:
  deploy:
    name: Deploy to EC2 Instance
    runs-on: ubuntu-latest
    
    steps:
    - name: Manual Checkout
      run: |
        git clone https://oauth2:${{ secrets.PAT_TOKEN }}@github.com/nataliea772/quizly-project.git .
        git checkout main

    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - name: Install dependencies
      run: npm install

    - name: Build project
      run: npm run build

    - name: Create deployment package
      run: |
        tar -czf deploy.tar.gz out/ server.js package.json package-lock.json nginx.conf
        ls -la deploy.tar.gz

    - name: Deploy to EC2
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.EC2_HOST }}
        username: 'ubuntu'
        key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
        port: 22
        script: |
          # Create deployment directory if it doesn't exist
          mkdir -p /home/ubuntu/quizapp
          
          # Install Node.js if not installed
          if ! command -v node &> /dev/null; then
            curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
            sudo apt-get install -y nodejs
          fi

          # Install Nginx if not installed
          if ! command -v nginx &> /dev/null; then
            sudo apt-get update
            sudo apt-get install -y nginx
          fi

          # Install PM2 if not installed
          if ! command -v pm2 &> /dev/null; then
            sudo npm install -g pm2
          fi

    - name: Copy files to EC2
      uses: appleboy/ssh-action@v1.0.0
      env:
        DEPLOY_PACKAGE: deploy.tar.gz
      with:
        host: ${{ secrets.EC2_HOST }}
        username: 'ubuntu'
        key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
        port: 22
        script_stop: true
        envs: DEPLOY_PACKAGE
        script: |
          # Clean and prepare directory
          cd /home/ubuntu/quizapp
          rm -rf out/ server.js package.json package-lock.json nginx.conf
          
          # Extract deployment package
          tar xzf $DEPLOY_PACKAGE
          
          # Setup Nginx configuration
          sudo cp nginx.conf /etc/nginx/sites-available/quizapp
          sudo ln -sf /etc/nginx/sites-available/quizapp /etc/nginx/sites-enabled/
          sudo rm -f /etc/nginx/sites-enabled/default
          sudo nginx -t && sudo systemctl restart nginx

          # Install dependencies and start application
          npm install
          pm2 restart quizapp || pm2 start server.js --name quizapp
          pm2 save
