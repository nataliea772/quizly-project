name: Deploy to EC2

on:
  push:
    branches:
      - main  # or your main deployment branch

jobs:
  deploy:
    name: Deploy to EC2 Instance
    runs-on: ubuntu-latest
    
    steps:
    - name: Manual Checkout
      run: |
        git clone https://oauth2:${{ secrets.PAT_TOKEN }}@github.com/nataliea772/quizly-project.git .
        git checkout main

    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - name: Install dependencies
      run: npm install

    - name: Build project
      run: npm run build

    - name: Upload build to EC2
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.EC2_HOST }}
        username: 'ubuntu'
        key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
        source: "out/*,server.js,package.json,package-lock.json,nginx.conf"
        target: "/home/ubuntu/quizapp"
        strip_components: 0

    - name: SSH and setup application
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.EC2_HOST }}
        username: 'ubuntu'
        key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
        script: |
          # Install Node.js if not installed
          if ! command -v node &> /dev/null; then
            curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
            sudo apt-get install -y nodejs
          fi

          # Install Nginx if not installed
          if ! command -v nginx &> /dev/null; then
            sudo apt-get update
            sudo apt-get install -y nginx
          fi

          # Install PM2 if not installed
          if ! command -v pm2 &> /dev/null; then
            sudo npm install -g pm2
          fi

          # Setup Nginx configuration
          cd /home/ubuntu/quizapp
          sudo cp nginx.conf /etc/nginx/sites-available/quizapp
          sudo ln -sf /etc/nginx/sites-available/quizapp /etc/nginx/sites-enabled/
          sudo rm -f /etc/nginx/sites-enabled/default
          sudo nginx -t && sudo systemctl restart nginx

          # Install dependencies and start application
          npm install
          pm2 restart quizapp || pm2 start server.js --name quizapp
          pm2 save
