name: Deploy to EC2

on:
  push:
    branches:
      - main  # or your main deployment branch

permissions:
  contents: read
  actions: write
  id-token: write

jobs:
  deploy:
    name: Deploy to EC2 Instance
    runs-on: ubuntu-latest
    
    steps:
    - name: Manual Checkout
      run: |
        git clone https://oauth2:${{ secrets.PAT_TOKEN }}@github.com/nataliea772/quizly-project.git .
        git checkout main

    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - name: Install dependencies
      run: npm install

    - name: Build project
      run: npm run build

    - name: Deploy to EC2
      uses: easingthemes/ssh-deploy@v4.1.8
      env:
        SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
        REMOTE_HOST: ${{ secrets.EC2_HOST }}
        REMOTE_USER: ubuntu
        SOURCE: "out/ server.js package.json package-lock.json nginx.conf"
        TARGET: /home/ubuntu/quizapp

    - name: Configure Server
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ubuntu
        key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
        script: |
          cd /home/ubuntu/quizapp
          npm install
          sudo cp nginx.conf /etc/nginx/sites-available/quizapp
          sudo ln -sf /etc/nginx/sites-available/quizapp /etc/nginx/sites-enabled/
          sudo rm -f /etc/nginx/sites-enabled/default
          sudo nginx -t && sudo systemctl restart nginx
          pm2 restart quizapp || pm2 start server.js --name quizapp
          pm2 save
